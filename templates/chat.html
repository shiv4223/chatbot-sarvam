<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>  <!-- Add language support -->
 <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
 <script id="MathJax-script" async 
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
.math-block {
  display: block;
  text-align: center;
  margin: 10px 0;
}

.math-inline {
  font-style: italic;
}

blockquote {
  border-left: 4px solid #ccc;
  padding-left: 10px;
  color: #666;
  font-style: italic;
}

ul, ol {
  padding-left: 20px;
}

code {
  background: #f4f4f4;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: monospace;
}


.reasoning-toggle {
  background-color: #3498db;
  color: white;
  border: none;
  padding: 8px;
  cursor: pointer;
  margin-bottom: 5px;
  border-radius: 5px;
  transition: background-color 0.3s;
}

.reasoning-toggle:hover {
  background-color: #2980b9;
}

.reasoning-text {
  background-color: #f1f1f1;
  padding: 10px;
  border-radius: 5px;
  text-align: left;
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease-in-out;
}



    pre {
    background-color: #1e1e1e; /* Dark background */
    color: #ffffff; /* Light text */
    padding: 10px;
    border-radius: 5px;
    font-family: "Courier New", monospace;
    overflow-x: auto;
}

code {
    color: #ffcc66; /* Light yellow for code */
}

/* Syntax Highlighting for Inline Code */
code.inline {
    background-color: #2d2d2d;
    color: #ffcc66;
    padding: 2px 4px;
    border-radius: 3px;
}

.message {
    position: relative;
    padding: 10px;
    border-radius: 10px;
    margin: 5px;
    max-width: 80%;
    word-wrap: break-word;
    background-color: #e6f0ff; /* Light blue background */
    color: #333; /* Dark text */
}

.message-mode {
    font-size: 10px;
    color: #666; /* Subtle gray color */
    position: absolute;
    bottom: 5px;
    right: 10px;
    text-align: right;
}


    
    :root {
      --body-bg: #f8f9fa;
      --chat-bg: #fff;
      --sidebar-bg: #e9ecef;
      --sidebar-text: #333;
      --chat-text: #333;
      --user-bubble-bg: #cfe2ff;
      --user-bubble-text: #0a58ca;
      --assistant-bubble-bg: #f1f3f5;
      --assistant-bubble-text: #333;
    }
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
      background-color: var(--body-bg);
      color: var(--chat-text);
      position: relative;
      transition: background-color 0.3s;
    }
    /* Sidebar and Chat Container */
    #toggle-sidebar-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
      font-size: 1.2rem;
      background: none;
      border: none;
      color: var(--sidebar-text);
      cursor: pointer;
    }
    #toggle-sidebar-btn:hover { color: #000; }
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background-color: var(--sidebar-bg);
      border-right: 1px solid #ced4da;
      box-shadow: 2px 0 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, background-color 0.3s;
      z-index: 1000;
      padding-top: 50px;
      color: var(--sidebar-text);
    }
    #sidebar.hidden { transform: translateX(-100%); }
    #sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      border-bottom: 1px solid #ced4da;
    }
    #sidebar-heading { margin: 0; font-size: 1rem; }
    #new-chat-btn {
      background: #28a745;
      border: none;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 4px;
    }
    #new-chat-btn:hover { background: #218838; }
    #logout-btn {
      background: none;
      border: none;
      color: var(--sidebar-text);
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: underline;
      padding: 4px 6px;
    }
    #logout-btn:hover { color: #000; }
    #chat-list-container {
      overflow-y: auto;
      padding: 10px 15px;
      height: calc(100% - 60px);
    }
    #conversation-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #conversation-list li {
      background: #f1f3f5;
      color: var(--sidebar-text);
      margin-bottom: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    #conversation-list li:hover { background-color: #e2e6ea; }
    #chat-container {
      position: absolute;
      top: 0;
      left: 280px;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      background-color: var(--chat-bg);
      transition: left 0.3s ease;
    }
    #chat-container.fullwidth { left: 0; }
    /* Chat Bar */
    #chat-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      box-sizing: border-box;
      z-index: 1100;
      border-top: 1px solid #ced4da;
      padding: 5px 10px;
      transition: background-color 0.3s;
    }
    #chat-bar-row1, #chat-bar-row2 {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    .label-text { font-weight: 500; margin-right: 4px; }
    /* Mode, Model, and Language Selects */
    #mode-select, #model-select, .lang-select {
      border: 1px solid #ced4da;
      background-color: #fff;
      color: #333;
      padding: 6px;
      border-radius: 4px;
    }
    /* Language Dropdowns for Translation mode */
    #language-dropdowns { display: none; }
    /* Alternative Target Language input for non-M2M translation models */
    #target-lang-input-container { display: none; }
    /* Hidden file input for images */
    #image-input { display: none; }
    .chat-bar-button {
      background: #adb5bd;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .chat-bar-button:hover { background: #868e96; }
    #message-textarea {
      flex: 1;
      border: 1px solid #ced4da;
      background-color: #fff;
      color: #333;
      padding: 6px;
      border-radius: 4px;
      resize: none;
      max-height: 150px;
      overflow-y: auto;
    }
    #message-textarea::placeholder { color: #777; }
    /* Preview Area */
    #preview-area {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
    }
    .preview-item { position: relative; display: inline-block; }
    .preview-item img {
      max-width: 80px;
      max-height: 80px;
      border-radius: 4px;
    }
    .remove-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: #dc3545;
      color: #fff;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      text-align: center;
      line-height: 18px;
    }
    .remove-btn:hover { background: #c82333; }
    /* Message Bubbles */
    .message {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 6px;
      max-width: 70%;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .message.user {
      background: var(--user-bubble-bg);
      color: var(--user-bubble-text);
      margin-left: auto;
      margin-right: 10px;
      text-align: left;
      transition: background-color 0.3s, color 0.3s;
    }
    .message.assistant {
      background: var(--assistant-bubble-bg);
      color: var(--assistant-bubble-text);
      margin-right: auto;
      margin-left: 10px;
      text-align: left;
      transition: background-color 0.3s, color 0.3s;
    }
    .message.user .meta-labels {
      display: block;
      font-size: 0.7rem;
      color: #495057;
      text-align: right;
      margin-top: 4px;
    }
    .chat-image {
      max-width: 200px;
      margin-top: 5px;
      border-radius: 4px;
      display: block;
    }
    audio { margin-top: 5px; outline: none; }
  </style>
</head>
<body>
  <!-- Chat UI -->
  <div id="chat-ui">
    <!-- Toggle Button -->
    <button id="toggle-sidebar-btn" title="Toggle Sidebar">
      <i class="bi bi-list"></i>
    </button>
    <!-- Sidebar: Previous Conversations and New Chat -->
    <div id="sidebar">
      <div id="sidebar-header">
        <h5 id="sidebar-heading">Conversations</h5>
        <div>
          <button id="new-chat-btn">New Chat</button>
          <button id="logout-btn">Logout</button>
        </div>
      </div>
      <div id="chat-list-container">
        <ul id="conversation-list"></ul>
      </div>
    </div>
    <!-- Chat Container -->
    <div id="chat-container"></div>
    <!-- Chat Bar -->
    <div id="chat-bar">
      <div id="chat-bar-row1">
        <div>
          <span class="label-text">Mode:</span>
          <select id="mode-select">
            <option value="General">General</option>
            <option value="Translation">Translation</option>
            <option value="Coding">Coding</option>
            <option value="Reasoning and Research">Reasoning and Research</option>
            <option value="Summarizing">Summarizing</option>
            <option value="Voice Transcript">Voice Transcript</option>
            <option value="Text to Image">Text to Image</option>
            <option value="Best Quality">Best Quality</option>
          </select>
        </div>
        <!-- Language Dropdowns for Translation mode -->
        <div id="language-dropdowns" style="display: none;">
          <span class="label-text">Source Language:</span>
          <select id="lang1-select" class="lang-select">
            <option value="af">Afrikaans</option>
            <option value="am">Amharic</option>
            <option value="ar">Arabic</option>
            <option value="ast">Asturian</option>
            <option value="az">Azerbaijani</option>
            <option value="ba">Bashkir</option>
            <option value="be">Belarusian</option>
            <option value="bg">Bulgarian</option>
            <option value="bn">Bengali</option>
            <option value="br">Breton</option>
            <option value="bs">Bosnian</option>
            <option value="ca">Catalan; Valencian</option>
            <option value="ceb">Cebuano</option>
            <option value="cs">Czech</option>
            <option value="cy">Welsh</option>
            <option value="da">Danish</option>
            <option value="de">German</option>
            <option value="el">Greek</option>
            <option value="en"selected>English</option>
            <option value="es">Spanish</option>
            <option value="et">Estonian</option>
            <option value="fa">Persian</option>
            <option value="ff">Fulah</option>
            <option value="fi">Finnish</option>
            <option value="fr">French</option>
            <option value="fy">Western Frisian</option>
            <option value="ga">Irish</option>
            <option value="gd">Gaelic; Scottish Gaelic</option>
            <option value="gl">Galician</option>
            <option value="gu">Gujarati</option>
            <option value="ha">Hausa</option>
            <option value="he">Hebrew</option>
            <option value="hi">Hindi</option>
            <option value="hr">Croatian</option>
            <option value="ht">Haitian; Haitian Creole</option>
            <option value="hu">Hungarian</option>
            <option value="hy">Armenian</option>
            <option value="id">Indonesian</option>
            <option value="ig">Igbo</option>
            <option value="ilo">Iloko</option>
            <option value="is">Icelandic</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="jv">Javanese</option>
            <option value="ka">Georgian</option>
            <option value="kk">Kazakh</option>
            <option value="km">Central Khmer</option>
            <option value="kn">Kannada</option>
            <option value="ko">Korean</option>
            <option value="lb">Luxembourgish</option>
            <option value="lg">Ganda</option>
            <option value="ln">Lingala</option>
            <option value="lo">Lao</option>
            <option value="lt">Lithuanian</option>
            <option value="lv">Latvian</option>
            <option value="mg">Malagasy</option>
            <option value="mk">Macedonian</option>
            <option value="ml">Malayalam</option>
            <option value="mn">Mongolian</option>
            <option value="mr">Marathi</option>
            <option value="ms">Malay</option>
            <option value="my">Burmese</option>
            <option value="ne">Nepali</option>
            <option value="nl">Dutch; Flemish</option>
            <option value="no">Norwegian</option>
            <option value="ns">Northern Sotho</option>
            <option value="oc">Occitan (post 1500)</option>
            <option value="or">Oriya</option>
            <option value="pa">Panjabi; Punjabi</option>
            <option value="pl">Polish</option>
            <option value="ps">Pushto; Pashto</option>
            <option value="pt">Portuguese</option>
            <option value="ro">Romanian</option>
            <option value="ru">Russian</option>
            <option value="sd">Sindhi</option>
            <option value="si">Sinhala; Sinhalese</option>
            <option value="sk">Slovak</option>
            <option value="sl">Slovenian</option>
            <option value="so">Somali</option>
            <option value="sq">Albanian</option>
            <option value="sr">Serbian</option>
            <option value="ss">Swati</option>
            <option value="su">Sundanese</option>
            <option value="sv">Swedish</option>
            <option value="sw">Swahili</option>
            <option value="ta">Tamil</option>
            <option value="th">Thai</option>
            <option value="tl">Tagalog</option>
            <option value="tn">Tswana</option>
            <option value="tr">Turkish</option>
            <option value="uk">Ukrainian</option>
            <option value="ur">Urdu</option>
            <option value="uz">Uzbek</option>
            <option value="vi">Vietnamese</option>
            <option value="wo">Wolof</option>
            <option value="xh">Xhosa</option>
            <option value="yi">Yiddish</option>
            <option value="yo">Yoruba</option>
            <option value="zh">Chinese</option>
            <option value="zu">Zulu</option>
          </select>
          <span class="label-text">Target Language:</span>
          <select id="lang2-select" class="lang-select">
            <option value="af">Afrikaans</option>
            <option value="am">Amharic</option>
            <option value="ar">Arabic</option>
            <option value="ast">Asturian</option>
            <option value="az">Azerbaijani</option>
            <option value="ba">Bashkir</option>
            <option value="be">Belarusian</option>
            <option value="bg">Bulgarian</option>
            <option value="bn">Bengali</option>
            <option value="br">Breton</option>
            <option value="bs">Bosnian</option>
            <option value="ca">Catalan; Valencian</option>
            <option value="ceb">Cebuano</option>
            <option value="cs">Czech</option>
            <option value="cy">Welsh</option>
            <option value="da">Danish</option>
            <option value="de">German</option>
            <option value="el">Greek</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="et">Estonian</option>
            <option value="fa">Persian</option>
            <option value="ff">Fulah</option>
            <option value="fi">Finnish</option>
            <option value="fr">French</option>
            <option value="fy">Western Frisian</option>
            <option value="ga">Irish</option>
            <option value="gd">Gaelic; Scottish Gaelic</option>
            <option value="gl">Galician</option>
            <option value="gu">Gujarati</option>
            <option value="ha">Hausa</option>
            <option value="he">Hebrew</option>
            <option value="hi" selected>Hindi</option>
            <option value="hr">Croatian</option>
            <option value="ht">Haitian; Haitian Creole</option>
            <option value="hu">Hungarian</option>
            <option value="hy">Armenian</option>
            <option value="id">Indonesian</option>
            <option value="ig">Igbo</option>
            <option value="ilo">Iloko</option>
            <option value="is">Icelandic</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="jv">Javanese</option>
            <option value="ka">Georgian</option>
            <option value="kk">Kazakh</option>
            <option value="km">Central Khmer</option>
            <option value="kn">Kannada</option>
            <option value="ko">Korean</option>
            <option value="lb">Luxembourgish</option>
            <option value="lg">Ganda</option>
            <option value="ln">Lingala</option>
            <option value="lo">Lao</option>
            <option value="lt">Lithuanian</option>
            <option value="lv">Latvian</option>
            <option value="mg">Malagasy</option>
            <option value="mk">Macedonian</option>
            <option value="ml">Malayalam</option>
            <option value="mn">Mongolian</option>
            <option value="mr">Marathi</option>
            <option value="ms">Malay</option>
            <option value="my">Burmese</option>
            <option value="ne">Nepali</option>
            <option value="nl">Dutch; Flemish</option>
            <option value="no">Norwegian</option>
            <option value="ns">Northern Sotho</option>
            <option value="oc">Occitan (post 1500)</option>
            <option value="or">Oriya</option>
            <option value="pa">Panjabi; Punjabi</option>
            <option value="pl">Polish</option>
            <option value="ps">Pushto; Pashto</option>
            <option value="pt">Portuguese</option>
            <option value="ro">Romanian</option>
            <option value="ru">Russian</option>
            <option value="sd">Sindhi</option>
            <option value="si">Sinhala; Sinhalese</option>
            <option value="sk">Slovak</option>
            <option value="sl">Slovenian</option>
            <option value="so">Somali</option>
            <option value="sq">Albanian</option>
            <option value="sr">Serbian</option>
            <option value="ss">Swati</option>
            <option value="su">Sundanese</option>
            <option value="sv">Swedish</option>
            <option value="sw">Swahili</option>
            <option value="ta">Tamil</option>
            <option value="th">Thai</option>
            <option value="tl">Tagalog</option>
            <option value="tn">Tswana</option>
            <option value="tr">Turkish</option>
            <option value="uk">Ukrainian</option>
            <option value="ur">Urdu</option>
            <option value="uz">Uzbek</option>
            <option value="vi">Vietnamese</option>
            <option value="wo">Wolof</option>
            <option value="xh">Xhosa</option>
            <option value="yi">Yiddish</option>
            <option value="yo">Yoruba</option>
            <option value="zh">Chinese</option>
            <option value="zu">Zulu</option>
          </select>
        </div>
        <!-- Alternative Target Language Input for non-M2M translation models (not used now) -->
        <div id="target-lang-input-container" style="display: none;">
          <span class="label-text">Target Language:</span>
          <input type="text" id="target-lang-input" placeholder="Enter target language" />
        </div>
        <div>
          <span class="label-text">Model:</span>
          <select id="model-select">
            <!-- Options will be populated dynamically -->
          </select>
        </div>
        <!-- Image upload button (hidden in Translation mode) -->
        <button id="image-upload-btn" class="chat-bar-button" title="Upload Image">
          <i class="bi bi-image"></i>
        </button>
        <input type="file" id="image-input" name="image" accept="image/*" />
      </div>
      <div id="chat-bar-row2">
        <textarea id="message-textarea" rows="1" placeholder="Ask anything..."></textarea>
        <button id="record-btn" class="chat-bar-button" title="Record Voice">
          <i class="bi bi-mic-fill"></i>
        </button>
        <button id="send-btn" class="chat-bar-button" title="Send">
          <i class="bi bi-send"></i>
        </button>
      </div>
      <div id="preview-area"></div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Helper: Convert file to base64 string
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    function formatResponse(response) {
    if (!response) return "<p><strong>Error:</strong> No response received.</p>";

    // Handle code blocks (```code```)
    response = response.replace(/```([\s\S]+?)```/g, function(match, code) {
        return `<pre><code class="language-python">${escapeHtml(code)}</code></pre>`;
    });

    // Handle inline code (`code`)
    response = response.replace(/`([^`\n]+)`/g, "<code>$1</code>");

    // Convert **Bold Text** to <strong>
    response = response.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

    // Convert *Italic Text* or _Italic_ to <em>
    response = response.replace(/\*(.*?)\*/g, "<em>$1</em>");
    response = response.replace(/_(.*?)_/g, "<em>$1</em>");

    // Convert Markdown-style Headings:
    response = response.replace(/^# (.*?)$/gm, "<h2>$1</h2>");  // # Heading → <h2>
    response = response.replace(/^## (.*?)$/gm, "<h3>$1</h3>"); // ## Heading → <h3>
    response = response.replace(/^### (.*?)$/gm, "<h4>$1</h4>"); // ### Heading → <h4>

    // Convert "--- # Heading" to <h3>
    response = response.replace(/--- # (.*?)$/gm, "<h3>$1</h3>");

    // Convert Blockquotes (`> text`) to <blockquote>
    response = response.replace(/^> (.*)$/gm, "<blockquote>$1</blockquote>");

    // Convert Bullet Points (- text) to <ul><li> (handles nested lists)
    response = response.replace(/^(\s*)- (.*)$/gm, function(match, spaces, text) {
        let depth = spaces.length / 2; // Detect indentation depth
        return `<ul class="list-depth-${depth}"><li>${text}</li></ul>`;
    });

    // Convert Ordered Lists (e.g., 1. Text) to <ol><li> (handles nesting)
    response = response.replace(/^(\s*)(\d+)\. (.*)$/gm, function(match, spaces, num, text) {
        let depth = spaces.length / 2; // Detect indentation depth
        return `<ol class="list-depth-${depth}"><li>${text}</li></ol>`;
    });

    // Convert Markdown Links [Text](URL) → <a href="URL">Text</a>
    response = response.replace(/\[([^\]]+)\]\((https?:\/\/[^\s]+)\)/g, '<a href="$2" target="_blank">$1</a>');

    // Convert Newlines (except inside code blocks)
    response = response.replace(/(?!<pre>[\s\S]*?)\n(?![\s\S]*?<\/pre>)/g, "<br>");

    // Handle LaTeX Block-Level Math Expressions ($$...$$)
    response = response.replace(/\$\$(.*?)\$\$/gs, function(match, latex) {
        return `<div class="math-block">\\[${latex}\\]</div>`;
    });

    // Handle LaTeX Inline Math Expressions ($...$)
    response = response.replace(/\$(.*?)\$/g, function(match, latex) {
        return `<span class="math-inline">\\(${latex}\\)</span>`;
    });

    // Apply syntax highlighting (if using Prism.js)
    setTimeout(() => Prism.highlightAll(), 100);

    // Render MathJax equations
    setTimeout(() => {
        if (window.MathJax) {
            MathJax.typeset();
        }
    }, 100);

    return response;
}

// Helper function to escape HTML in code blocks
function escapeHtml(text) {
    return text.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;");
}







    // Check login
    if (!localStorage.getItem("isLoggedIn")) {
      window.location.href = "login.html";
    }
    const userId = localStorage.getItem("user_id");
    let currentConversationId = null;

    // Logout functionality
    const logoutBtn = document.getElementById("logout-btn");
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("user_id");
      window.location.href = "login.html";
    });

    // New Chat: clear current conversation
    const newChatBtn = document.getElementById("new-chat-btn");
    newChatBtn.addEventListener("click", () => {
      currentConversationId = null;
      chatContainer.innerHTML = "";
    });

    // Sidebar toggle
    const toggleSidebarBtn = document.getElementById("toggle-sidebar-btn");
    const sidebar = document.getElementById("sidebar");
    const chatContainer = document.getElementById("chat-container");
    toggleSidebarBtn.addEventListener("click", () => {
      sidebar.classList.toggle("hidden");
      chatContainer.classList.toggle("fullwidth");
    });

    // Load previous conversations from backend
    async function loadConversations() {
      if (!userId || userId === "null") {
        console.error("No valid user_id found.");
        return;
      }
      try {
        const res = await fetch(`http://127.0.0.1:5000/conversations/${userId}`);
        const data = await res.json();
        console.log("Conversations:", data);
        const conversationList = document.getElementById("conversation-list");
        conversationList.innerHTML = "";
        data.forEach(conv => {
          const li = document.createElement("li");
          li.textContent = conv.title || conv.id;
          li.dataset.conversationId = conv.id;
          li.addEventListener("click", () => loadConversation(conv.id));
          conversationList.appendChild(li);
        });
      } catch (err) {
        console.error("Error loading conversations:", err);
      }
    }
    loadConversations();

    // Load conversation messages and format them using formatResponse()
    async function loadConversation(conversationId) {
    try {
        const res = await fetch(`http://127.0.0.1:5000/conversation/${conversationId}`);
        const data = await res.json();
        console.log("Conversation messages:", data);
        currentConversationId = conversationId;
        chatContainer.innerHTML = "";

        data.forEach(msg => {
            // **User Message Bubble**
            const userDiv = document.createElement("div");
            userDiv.classList.add("message", "user");
            userDiv.innerHTML = formatResponse(msg.message);

            // If user uploaded an image, display it
            if (msg.image) {
                const img = new Image();
                img.src = msg.image;
                img.classList.add("chat-image");
                userDiv.appendChild(img);
            }

            // Add mode label for user message
            const userMode = document.createElement("div");
            userMode.classList.add("message-mode");
            userMode.innerText = msg.mode;
            userDiv.appendChild(userMode);
            chatContainer.appendChild(userDiv);

            // **Assistant Message Bubble**
            const assistantDiv = document.createElement("div");
            assistantDiv.classList.add("message", "assistant");

            // **If "Text to Image" Mode, Display Generated Image**
            if (msg.mode === "Text to Image") {
                const img = new Image();
                img.src = `data:image/png;base64,${msg.response}`;
                img.classList.add("chat-image");
                assistantDiv.innerHTML = "<strong>Your AI Generated Image:</strong><br>";
                assistantDiv.appendChild(img);
            } else {
                // **Show Model Reasoning if available**
                if (msg.reasoning) {
                    const reasoningSection = createReasoningSection(msg.reasoning);
                    assistantDiv.appendChild(reasoningSection);
                }

                // Append AI text response
                let responseTextDiv = document.createElement("div");
                responseTextDiv.innerHTML = formatResponse(msg.response);
                assistantDiv.appendChild(responseTextDiv);
            }

            // Add mode label for assistant message
            const assistantMode = document.createElement("div");
            assistantMode.classList.add("message-mode");
            assistantMode.innerText = msg.mode;
            assistantDiv.appendChild(assistantMode);

            chatContainer.appendChild(assistantDiv);
        });

        chatContainer.scrollTop = chatContainer.scrollHeight;
    } catch (err) {
        console.error("Error loading conversation:", err);
    }
}



function createReasoningSection(reasoningText) {
    let reasoningContainer = document.createElement("div");
    reasoningContainer.classList.add("reasoning-container");

    let reasoningTitle = document.createElement("button");
    reasoningTitle.classList.add("reasoning-toggle");
    reasoningTitle.textContent = "Press for Reasoning";

    let reasoningTextDiv = document.createElement("div");
    reasoningTextDiv.classList.add("reasoning-text");
    reasoningTextDiv.innerHTML = formatResponse(reasoningText || "No reasoning provided.");
    reasoningTextDiv.style.display = "none"; // Initially hidden

    // Toggle visibility when clicked
    reasoningTitle.addEventListener("click", function () {
        if (reasoningTextDiv.style.display === "none") {
            reasoningTextDiv.style.display = "block";
            reasoningTextDiv.style.maxHeight = reasoningTextDiv.scrollHeight + "px";
        } else {
            reasoningTextDiv.style.display = "none";
            reasoningTextDiv.style.maxHeight = "0";
        }
    });

    reasoningContainer.appendChild(reasoningTitle);
    reasoningContainer.appendChild(reasoningTextDiv);

    return reasoningContainer;
}






    // --- Dynamic Model Options and Language Dropdown Visibility ---
    const modeSelect = document.getElementById("mode-select");
    const modelSelect = document.getElementById("model-select");
    const imageInput = document.getElementById("image-input");
    const langDropdowns = document.getElementById("language-dropdowns");
    const targetLangInputContainer = document.getElementById("target-lang-input-container");
    let recordedAudioBlob = null;
    
    const modelOptions = {
      "General": ["No Selection", "Meta Llama 3.1 8B", "Llama 3.3 70B versatile", "Deepseek R1 zero", "Google Gemini Flash", "Deepseek R1", "Deepseek Chat",  "Mixtral Chat", "Llama 3.2 1B", "Llama 3.2 3B", "Meta Llama Vision Openrouter", "Grok 2 Vision", "Qwen 2.5 VL 72B Instruct Openrouter", "Deepseek R1 Distill Qwen"],
      "Translation": ["M2M 100 translation"],  // Only M2M is allowed in Translation mode
      "Coding": ["No Selection","Olypic Coder 7B", "Olypic Coder 32B", "Qwen 2.5 Coder 32B", "Mixtral Chat", "Deepseek Chat", "Llama 3.3 70B versatile", "Deepseek R1", "Deepseek R1 zero"],
      "Summarizing": ["No Selection", "Llama 3.2 1B", "Google Gemma 3 1B", "Llama 3.2 3B", "Google Gemma 3 4B", "Meta Llama 3.1 8B"],
      "Reasoning and Research": ["No Selection", "Deepseek Chat", "Deepseek R1 zero", "Deepseek R1", "Mixtral Chat"],
      "Text to Image": ["No Selection", "Black Forest Flux Schnell", "SDXL 1.0 Yamers Realistic"],
      "Voice Transcript": ["Whisper Transcription"],
      "Best Quality": ["No Selection", "Deepseek R1 zero", "Deepseek R1", "Mixtral Chat", "Llama 3.3 70B versatile", "Deepseek Chat"]
    };
    const imageOptions = ["Meta Llama Vision Openrouter", "Grok 2 Vision", "Google Gemini Flash Openrouter", "Qwen 2.5 VL 72B Instruct Openrouter", "Google Gemini Flash"];
    const audioOptions = ["Whisper Transcription"];

    function updateModelOptions() {
      let options = [];
      const hasImage = imageInput.files && imageInput.files.length > 0;
      const hasAudio = recordedAudioBlob !== null;
      const mode = modeSelect.value;
      
      // For Translation mode, force the model to "M2M 100 translation"
      if (mode === "Translation") {
        options = modelOptions["Translation"];

      } else if (mode === "Text to Image") {
        options = modelOptions["Text to Image"];
      } else if (hasAudio && !hasImage) {
        options = audioOptions;
      } else if (hasImage && mode !== "Translation") {
        options = imageOptions;
      } else {
        options = modelOptions[mode] || modelOptions["General"];
      }
      modelSelect.innerHTML = "";
      options.forEach((model) => {
        const opt = document.createElement("option");
        opt.value = model;
        opt.textContent = model;
        modelSelect.appendChild(opt);
      });
    }

    // Update language dropdowns and image button visibility based on mode changes
    modeSelect.addEventListener("change", () => {
      updateModelOptions();
      if (modeSelect.value === "Translation") {
        langDropdowns.style.display = "inline-block";
        targetLangInputContainer.style.display = "none";
        document.getElementById("image-upload-btn").style.display = "none";
      } else {
        langDropdowns.style.display = "none";
        targetLangInputContainer.style.display = "none";
        document.getElementById("image-upload-btn").style.display = "inline-block";
      }
    });
    modelSelect.addEventListener("change", () => {
      if (modeSelect.value === "Translation") {
        langDropdowns.style.display = "inline-block";
        targetLangInputContainer.style.display = "none";
      }
    });
    imageInput.addEventListener("change", () => {
      updatePreview();
      updateModelOptions();
    });
    updateModelOptions();

    // --- Image/Audio Preview Logic ---
    const previewArea = document.getElementById("preview-area");
    const imageUploadBtn = document.getElementById("image-upload-btn");
    imageUploadBtn.addEventListener("click", () => { imageInput.click(); });
    imageInput.addEventListener("change", () => { updatePreview(); updateModelOptions(); });
    function updatePreview() {
      previewArea.innerHTML = "";
      if (imageInput.files[0]) {
        const imgFile = imageInput.files[0];
        const imgURL = URL.createObjectURL(imgFile);
        const previewItem = document.createElement("div");
        previewItem.classList.add("preview-item");
        previewItem.innerHTML = `
          <img src="${imgURL}" alt="Preview" />
          <button class="remove-btn">&times;</button>
        `;
        previewArea.appendChild(previewItem);
        previewItem.querySelector(".remove-btn").addEventListener("click", () => {
          imageInput.value = "";
          updatePreview();
          updateModelOptions();
        });
      }
      if (recordedAudioBlob) {
        const audioURL = URL.createObjectURL(recordedAudioBlob);
        const previewItem = document.createElement("div");
        previewItem.classList.add("preview-item");
        previewItem.innerHTML = `
          <audio controls src="${audioURL}"></audio>
          <button class="remove-btn">&times;</button>
        `;
        previewArea.appendChild(previewItem);
        previewItem.querySelector(".remove-btn").addEventListener("click", () => {
          recordedAudioBlob = null;
          updatePreview();
          updateModelOptions();
        });
      }
    }

    // --- Auto-resize Textarea and Update Chat Container Bottom ---
    const messageTextarea = document.getElementById("message-textarea");
    messageTextarea.addEventListener("input", () => {
      messageTextarea.style.height = "auto";
      messageTextarea.style.height = messageTextarea.scrollHeight + "px";
      updateChatBarHeight();
    });
    function updateChatBarHeight() {
      const barHeight = document.getElementById("chat-bar").offsetHeight;
      chatContainer.style.bottom = barHeight + "px";
    }
    window.addEventListener("load", updateChatBarHeight);
    window.addEventListener("resize", updateChatBarHeight);

    // --- Send Message Functionality using JSON payload with base64 image and audio ---
    const sendBtn = document.getElementById("send-btn");
    sendBtn.addEventListener("click", sendMessage);
    messageTextarea.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
  const msg = messageTextarea.value.trim();
  const selectedMode = modeSelect.value;
  const selectedModel = modelSelect.value;
  if (!msg && !imageInput.files[0] && !recordedAudioBlob) {
    console.log("No content to send.");
    return;
  }
  console.log("Sending message...", msg);

  // Capture file(s) before clearing inputs
  const imageFile = imageInput.files[0] || null;

  // Disable send button until response is received
  sendBtn.disabled = true;

  // Create user message bubble
  const userDiv = document.createElement("div");
  userDiv.classList.add("message", "user");
  let bubbleContent = `<div>${msg}</div>`;

  if (imageFile) {
    const imgURL = URL.createObjectURL(imageFile);
    bubbleContent += `<img src="${imgURL}" class="chat-image" alt="Uploaded Image" />`;
  }
  if (recordedAudioBlob) {
    const audioURL = URL.createObjectURL(recordedAudioBlob);
    bubbleContent += `<audio controls src="${audioURL}"></audio>`;
  }
  bubbleContent += `<div class="meta-labels"><small>${selectedMode} | ${selectedModel}</small></div>`;
  userDiv.innerHTML = bubbleContent;
  chatContainer.appendChild(userDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  // Clear inputs
  messageTextarea.value = "";
  previewArea.innerHTML = "";
  messageTextarea.style.height = "auto";
  updateChatBarHeight();
  updateModelOptions();

  // Create temporary assistant bubble
  let tempAssistantDiv = document.createElement("div");
  tempAssistantDiv.classList.add("message", "assistant");
  tempAssistantDiv.textContent = "Processing...";
  chatContainer.appendChild(tempAssistantDiv);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  // Convert image/audio to base64 if available
  let imageData = "";
  if (imageFile) {
    try {
      imageData = await fileToBase64(imageFile);
    } catch (err) {
      console.error("Error converting image:", err);
    }
  }
  let voiceData = "";
  if (recordedAudioBlob) {
    try {
      const audioFile = new File([recordedAudioBlob], "recording.webm");
      voiceData = await fileToBase64(audioFile);
    } catch (err) {
      console.error("Error converting audio:", err);
    }
  }

  imageInput.value = "";

  const sourceLangSelect = document.getElementById("lang1-select");
  const targetLangSelect = document.getElementById("lang2-select");

  // Prepare JSON payload
  const payload = {
    user_id: userId,
    message: msg,
    context_mode: "relevant",
    conversation_id: currentConversationId || "",
    model: selectedModel,
    mode: selectedMode,
    image: imageData,
    voice: voiceData,
    source_lang: sourceLangSelect?.value || "en",  // Fallback to "en" if null
    target_lang: targetLangSelect?.value || "hi"   // Fallback to "hi" if null

  };

  try {
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error("Server Error: No response from server.")), 300000)
    );
    const fetchPromise = fetch("http://127.0.0.1:5000/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const res = await Promise.race([fetchPromise, timeoutPromise]);
    const data = await res.json();
    console.log("Chat response:", data);

    if (!currentConversationId && data.conversation_id) {
      currentConversationId = data.conversation_id;
      loadConversations();
    }

    // **Remove Temporary Assistant Bubble Before Adding New Response**
    tempAssistantDiv.remove();

    let assistantDiv = document.createElement("div");
    assistantDiv.classList.add("message", "assistant");

    // **Ensure Reasoning is Added for "Deepseek R1" and "Deepseek R1 Zero"**
    if (data.reasoning || selectedModel === "Deepseek R1" || selectedModel === "Deepseek R1 Zero") {
      const reasoningSection = createReasoningSection(data.reasoning || "No reasoning provided.");
      assistantDiv.appendChild(reasoningSection);
    }

    // **Handle Image for Text-to-Image Mode**
    if (selectedMode === "Text to Image") {
      const img = new Image();
      img.src = `data:image/png;base64,${data.response}`;
      img.classList.add("chat-image");
      assistantDiv.appendChild(img);
      assistantDiv.innerHTML = "<strong>Your AI Generated Image:</strong><br>" + assistantDiv.innerHTML;
    } else {
      // **Ensure response is not empty before displaying**
      if (data.response && data.response.trim() !== "") {
        assistantDiv.innerHTML += formatResponse(data.response);
      }
    }

    chatContainer.appendChild(assistantDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

  } catch (err) {
    console.error("Error sending chat:", err);
    tempAssistantDiv.textContent = "Server Error: No response from server.";
  }

  recordedAudioBlob = null;
  sendBtn.disabled = false;
}



    // --- Voice Recording ---
    let isRecording = false;
    let mediaRecorder = null;
    const recordBtn = document.getElementById("record-btn");
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      recordBtn.addEventListener("click", async () => {
        if (!isRecording) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            isRecording = true;
            recordedAudioBlob = null;
            recordBtn.style.backgroundColor = "#ff6b6b";
            mediaRecorder.ondataavailable = (e) => {
              if (e.data.size > 0) {
                recordedAudioBlob = e.data;
                console.log("Recorded audio blob captured:", recordedAudioBlob);
              }
            };
          } catch (err) {
            console.error("Error accessing microphone:", err);
          }
        } else {
          mediaRecorder.stop();
          isRecording = false;
          recordBtn.style.backgroundColor = "";
          setTimeout(() => {
            updatePreview();
          }, 300);
        }
      });
    } else {
      recordBtn.disabled = true;
      recordBtn.title = "Recording not supported in this browser.";
    }
  </script>
</body>
</html>